<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alluvial Diagrams in ggplot2 • ggalluvial</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Alluvial Diagrams in ggplot2">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ggalluvial</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.10.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/ggalluvial.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/labels.html">Labeling small strata</a>
    </li>
    <li>
      <a href="../articles/order-rectangles.html">The Order of the Rectangles</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Alluvial Diagrams in ggplot2</h1>
                        <h4 class="author">Jason Cory Brunson</h4>
            
            <h4 class="date">2019-09-02</h4>
      
      
      <div class="hidden name"><code>ggalluvial.rmd</code></div>

    </div>

    
    
<p>The <strong>ggalluvial</strong> package strives to adapt the style and flexibility of the <a href="https://github.com/mbojan/alluvial"><strong>alluvial</strong></a> package to the principles and frameworks of the <a href="https://github.com/tidyverse"><strong>tidyverse</strong></a>. This vignette</p>
<ul>
<li>defines the essential components of alluvial diagrams as used in the naming schemes and documentation (<em>axis</em>, <em>alluvium</em>, <em>stratum</em>, <em>lode</em>, <em>flow</em>),</li>
<li>describes the alluvial data structures recognized by <strong>ggalluvial</strong>,</li>
<li>illustrates the new stats and geoms, and</li>
<li>showcases some popular variants on the theme and how to produce them.</li>
</ul>
<p>Many other resources exist for visualizing categorical data in R, including several more basic plot types that are likely to more accurately convey proportions to viewers when the data are not so structured as to warrant an alluvial diagram. In particular, check out Michael Friendly’s <a href="https://CRAN.R-project.org/package=vcdExtra/vignettes/vcd-tutorial.pdf"><strong>vcd</strong> and <strong>vcdExtra</strong> packages (PDF)</a> for a variety of statistically-motivated categorical data visualization techniques, Hadley Wickham’s <a href="https://github.com/hadley/productplots"><strong>productplots</strong> package</a> and Haley Jeppson and Heike Hofmann’s descendant <a href="https://CRAN.R-project.org/package=ggmosaic/vignettes/ggmosaic.html"><strong>ggmosaic</strong> package</a> for product or mosaic plots, and Nicholas Hamilton’s <a href="http://www.ggtern.com/"><strong>ggtern</strong> package</a> for ternary coordinates. Other related packages are mentioned below.</p>
<div id="alluvial-diagrams" class="section level2">
<h2 class="hasAnchor">
<a href="#alluvial-diagrams" class="anchor"></a>Alluvial diagrams</h2>
<p>Here’s a quintessential alluvial diagram:</p>
<p><img src="ggalluvial_files/figure-html/example%20alluvial%20diagram%20using%20Titanic%20dataset-1.png" width="576" style="display: block; margin: auto;"></p>
<p>The next section details how the elements of this image encode information about the underlying dataset. For now, we use the image as a point of reference to define the following elements of a typical alluvial diagram:</p>
<ul>
<li>An <em>axis</em> is a dimension (variable) along which the data are vertically grouped at a fixed horizontal position. The diagram above uses three categorical axes: <code>Class</code>, <code>Sex</code>, and <code>Age</code>.</li>
<li>The groups at each axis are depicted as opaque blocks called <em>strata</em>. For example, the <code>Class</code> axis contains four strata: <code>1st</code>, <code>2nd</code>, <code>3rd</code>, and <code>Crew</code>.</li>
<li>Horizontal (x-) splines called <em>alluvia</em> span the width of the diagram. In this diagram, each alluvium corresponds to a fixed value of each axis variable, indicated by its vertical position at the axis, as well as of the <code>Survived</code> variable, indicated by its fill color.</li>
<li>The segments of the alluvia between pairs of adjacent axes are <em>flows</em>.</li>
<li>The alluvia intersect the strata at <em>lodes</em>. The lodes are not visualized in the above diagram, but they can be inferred as filled rectangles extending the flows through the strata at each end of the diagram or connecting the flows on either side of the center stratum.</li>
</ul>
<p>As the examples in the next section will demonstrate, which of these elements are incorporated into an alluvial diagram depends on both how the underlying data is structured and what the creator wants the diagram to communicate.</p>
</div>
<div id="alluvial-data" class="section level2">
<h2 class="hasAnchor">
<a href="#alluvial-data" class="anchor"></a>Alluvial data</h2>
<p><strong>ggalluvial</strong> recognizes two formats of “alluvial data”, treated in detail in the following subsections, but which basically correspond to the “wide” and “long” formats of categorical repeated measures data. A third, tabular (or array), form is popular for storing data with multiple categorical dimensions, such as the <code>Titanic</code> and <code>UCBAdmissions</code> datasets.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> For consistency with tidy data principles and <strong>ggplot2</strong> conventions, <strong>ggalluvial</strong> does not accept tabular input; <code><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">base::data.frame()</a></code> converts such an array to an acceptable data frame.</p>
<div id="alluvia-wide-format" class="section level3">
<h3 class="hasAnchor">
<a href="#alluvia-wide-format" class="anchor"></a>Alluvia (wide) format</h3>
<p>The wide format reflects the visual arrangement of an alluvial diagram, but “untwisted”: Each row corresponds to a cohort of observations that take a specific value at each variable, and each variable has its own column. An additional column contains the weight of each row, e.g. the number of observational units in the cohort, which may be used to control the heights of the strata.<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a> Basically, the wide format consists of <em>one row per alluvium</em>. This is the format into which the base function <code><a href="https://www.rdocumentation.org/packages/base/topics/as.data.frame">as.data.frame()</a></code> transforms a frequency table, for instance the 3-dimensional <code>UCBAdmissions</code> dataset:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.data.frame">as.data.frame</a></span>(UCBAdmissions), <span class="dt">n =</span> <span class="dv">12</span>)</a></code></pre></div>
<pre><code>##       Admit Gender Dept Freq
## 1  Admitted   Male    A  512
## 2  Rejected   Male    A  313
## 3  Admitted Female    A   89
## 4  Rejected Female    A   19
## 5  Admitted   Male    B  353
## 6  Rejected   Male    B  207
## 7  Admitted Female    B   17
## 8  Rejected Female    B    8
## 9  Admitted   Male    C  120
## 10 Rejected   Male    C  205
## 11 Admitted Female    C  202
## 12 Rejected Female    C  391</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw"><a href="../reference/alluvial-data.html">is_alluvia_form</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.data.frame">as.data.frame</a></span>(UCBAdmissions), <span class="dt">axes =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">silent =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>This format is inherited from the first version of <strong>ggalluvial</strong>, which modeled it after usage in <strong>alluvial</strong>: The user declares any number of axis variables, which <code><a href="../reference/stat_alluvium.html">stat_alluvium()</a></code> and <code><a href="../reference/stat_stratum.html">stat_stratum()</a></code> recognize and process in a consistent way:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">ggplot</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.data.frame">as.data.frame</a></span>(UCBAdmissions),</a>
<a class="sourceLine" id="cb5-2" title="2">       <span class="kw">aes</span>(<span class="dt">y =</span> Freq, <span class="dt">axis1 =</span> Gender, <span class="dt">axis2 =</span> Dept)) <span class="op">+</span></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="st">  </span><span class="kw"><a href="../reference/geom_alluvium.html">geom_alluvium</a></span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Admit), <span class="dt">width =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">12</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="st">  </span><span class="kw"><a href="../reference/geom_stratum.html">geom_stratum</a></span>(<span class="dt">width =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">12</span>, <span class="dt">fill =</span> <span class="st">"black"</span>, <span class="dt">color =</span> <span class="st">"grey"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="st">  </span><span class="kw">geom_label</span>(<span class="dt">stat =</span> <span class="st">"stratum"</span>, <span class="dt">label.strata =</span> <span class="ot">TRUE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="dt">limits =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Gender"</span>, <span class="st">"Dept"</span>), <span class="dt">expand =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(.<span class="dv">05</span>, <span class="fl">.05</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="st">  </span><span class="kw">scale_fill_brewer</span>(<span class="dt">type =</span> <span class="st">"qual"</span>, <span class="dt">palette =</span> <span class="st">"Set1"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb5-8" title="8"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">"UC Berkeley admissions and rejections, by sex and department"</span>)</a></code></pre></div>
<p><img src="ggalluvial_files/figure-html/alluvial%20diagram%20of%20UC%20Berkeley%20admissions%20dataset-1.png" width="576" style="display: block; margin: auto;"></p>
<p>An important feature of these diagrams is the meaningfulness of the vertical axis: No gaps are inserted between the strata, so the total height of the diagram reflects the cumulative weight of the observations. The diagrams produced by <strong>ggalluvial</strong> conform (somewhat; keep reading) to the “grammar of graphics” principles of <strong>ggplot2</strong>, and this prevents users from producing “free-floating” diagrams like the Sankey diagrams showcased <a href="https://developers.google.com/chart/interactive/docs/gallery/sankey">here</a>.<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a> <strong>ggalluvial</strong> parameters and existing <strong>ggplot2</strong> functionality can also produce <a href="https://eagereyes.org/parallel-sets">parallel sets</a> plots, illustrated here using the <code>Titanic</code> dataset:<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">ggplot</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.data.frame">as.data.frame</a></span>(Titanic),</a>
<a class="sourceLine" id="cb6-2" title="2">       <span class="kw">aes</span>(<span class="dt">y =</span> Freq,</a>
<a class="sourceLine" id="cb6-3" title="3">           <span class="dt">axis1 =</span> Survived, <span class="dt">axis2 =</span> Sex, <span class="dt">axis3 =</span> Class)) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="st">  </span><span class="kw"><a href="../reference/geom_alluvium.html">geom_alluvium</a></span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Class),</a>
<a class="sourceLine" id="cb6-5" title="5">                <span class="dt">width =</span> <span class="dv">0</span>, <span class="dt">knot.pos =</span> <span class="dv">0</span>, <span class="dt">reverse =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-6" title="6"><span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="st">  </span><span class="kw"><a href="../reference/geom_stratum.html">geom_stratum</a></span>(<span class="dt">width =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">8</span>, <span class="dt">reverse =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-8" title="8"><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">stat =</span> <span class="st">"stratum"</span>, <span class="dt">label.strata =</span> <span class="ot">TRUE</span>, <span class="dt">reverse =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-9" title="9"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">labels =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Survived"</span>, <span class="st">"Sex"</span>, <span class="st">"Class"</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-10" title="10"><span class="st">  </span><span class="kw">coord_flip</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb6-11" title="11"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">"Titanic survival by class and sex"</span>)</a></code></pre></div>
<p><img src="ggalluvial_files/figure-html/parallel%20sets%20plot%20of%20Titanic%20dataset-1.png" width="576" style="display: block; margin: auto;"></p>
<p>This format and functionality are useful for many applications and will be retained in future versions. They also involve some conspicuous deviations from <strong>ggplot2</strong> norms:</p>
<ul>
<li>The <code>axis[0-9]*</code> position aesthetics are non-standard: they are not an explicit set of parameters but a family based on a regular expression pattern; and at least one, but no specific one, is required.</li>
<li>
<code><a href="../reference/stat_alluvium.html">stat_alluvium()</a></code> ignores any argument to the <code>group</code> aesthetic; instead, <code>StatAlluvium$compute_panel()</code> uses <code>group</code> to link the rows of the internally-transformed dataset that correspond to the same alluvium.</li>
<li>The <code>label.strata</code> parameter instructs <code><a href="../reference/stat_stratum.html">stat_stratum()</a></code> (called by <code>geom_text()</code>) to take the values of the axis variables as labels.</li>
<li>The horizontal axis must be manually corrected (using <code>scale_x_discrete()</code> or <code>scale_x_continuous()</code>) to reflect the implicit categorical variable identifying the axis.</li>
</ul>
<p>Furthermore, format aesthetics like <code>fill</code> are necessarily fixed for each alluvium; they cannot, for example, change from axis to axis according to the value taken at each. This means that, although they can reproduce the branching-tree structure of parallel sets, this format and functionality cannot produce alluvial diagrams with the color schemes featured <a href="https://epijim.uk/code-snippets/eq5d/">here</a> (“Alluvial diagram”) and <a href="https://developers.google.com/chart/interactive/docs/gallery/sankey">here</a> (“Controlling colors”), which are “reset” at each axis.</p>
</div>
<div id="lodes-long-format" class="section level3">
<h3 class="hasAnchor">
<a href="#lodes-long-format" class="anchor"></a>Lodes (long) format</h3>
<p>The long format recognized by <strong>ggalluvial</strong> contains <em>one row per lode</em>, and can be understood as the result of “gathering” (in the <strong>dplyr</strong> sense) or “pivoting” (in the Microsoft Excel sense) the axis columns of a dataset in the alluvia format into a key-value pair of columns encoding the axis as the key and the stratum as the value. This format requires an additional indexing column that links the rows corresponding to a common cohort, i.e. the lodes of a single alluvium:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">UCB_lodes &lt;-<span class="st"> </span><span class="kw"><a href="../reference/alluvial-data.html">to_lodes_form</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.data.frame">as.data.frame</a></span>(UCBAdmissions),</a>
<a class="sourceLine" id="cb7-2" title="2">                           <span class="dt">axes =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>,</a>
<a class="sourceLine" id="cb7-3" title="3">                           <span class="dt">id =</span> <span class="st">"Cohort"</span>)</a>
<a class="sourceLine" id="cb7-4" title="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(UCB_lodes, <span class="dt">n =</span> <span class="dv">12</span>)</a></code></pre></div>
<pre><code>##    Freq Cohort     x  stratum
## 1   512      1 Admit Admitted
## 2   313      2 Admit Rejected
## 3    89      3 Admit Admitted
## 4    19      4 Admit Rejected
## 5   353      5 Admit Admitted
## 6   207      6 Admit Rejected
## 7    17      7 Admit Admitted
## 8     8      8 Admit Rejected
## 9   120      9 Admit Admitted
## 10  205     10 Admit Rejected
## 11  202     11 Admit Admitted
## 12  391     12 Admit Rejected</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="kw"><a href="../reference/alluvial-data.html">is_lodes_form</a></span>(UCB_lodes, <span class="dt">key =</span> x, <span class="dt">value =</span> stratum, <span class="dt">id =</span> Cohort, <span class="dt">silent =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>The functions that convert data between wide (alluvia) and long (lodes) format include several parameters that help preserve ancillary information. See <code><a href="https://www.rdocumentation.org/packages/utils/topics/help">help("alluvial-data")</a></code> for examples.</p>
<p>The same stat and geom can receive data in this format using a different set of positional aesthetics, also specific to <strong>ggalluvial</strong>:</p>
<ul>
<li>
<code>x</code>, the “key” variable indicating the axis to which the row corresponds, which are to be arranged along the horizontal axis;</li>
<li>
<code>stratum</code>, the “value” taken by the axis variable indicated by <code>x</code>; and</li>
<li>
<code>alluvium</code>, the indexing scheme that links the rows of a single alluvium.</li>
</ul>
<p>Heights can vary from axis to axis, allowing users to produce bump charts like those showcased <a href="http://imgur.com/gallery/gI5p7">here</a>.<a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a> In these cases, the strata contain no more information than the alluvia and often not plotted. For convenience, both <code><a href="../reference/stat_alluvium.html">stat_alluvium()</a></code> and <code><a href="../reference/stat_flow.html">stat_flow()</a></code> will accept arguments for <code>x</code> and <code>alluvium</code> even if none is given for <code>stratum</code>.<a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a> As an example, we can group countries in the <code>Refugees</code> dataset by region, in order to compare refugee volumes at different scales:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(Refugees, <span class="dt">package =</span> <span class="st">"alluvial"</span>)</a>
<a class="sourceLine" id="cb11-2" title="2">country_regions &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(</a>
<a class="sourceLine" id="cb11-3" title="3">  <span class="dt">Afghanistan =</span> <span class="st">"Middle East"</span>,</a>
<a class="sourceLine" id="cb11-4" title="4">  <span class="dt">Burundi =</span> <span class="st">"Central Africa"</span>,</a>
<a class="sourceLine" id="cb11-5" title="5">  <span class="st">`</span><span class="dt">Congo DRC</span><span class="st">`</span> =<span class="st"> "Central Africa"</span>,</a>
<a class="sourceLine" id="cb11-6" title="6">  <span class="dt">Iraq =</span> <span class="st">"Middle East"</span>,</a>
<a class="sourceLine" id="cb11-7" title="7">  <span class="dt">Myanmar =</span> <span class="st">"Southeast Asia"</span>,</a>
<a class="sourceLine" id="cb11-8" title="8">  <span class="dt">Palestine =</span> <span class="st">"Middle East"</span>,</a>
<a class="sourceLine" id="cb11-9" title="9">  <span class="dt">Somalia =</span> <span class="st">"Horn of Africa"</span>,</a>
<a class="sourceLine" id="cb11-10" title="10">  <span class="dt">Sudan =</span> <span class="st">"Central Africa"</span>,</a>
<a class="sourceLine" id="cb11-11" title="11">  <span class="dt">Syria =</span> <span class="st">"Middle East"</span>,</a>
<a class="sourceLine" id="cb11-12" title="12">  <span class="dt">Vietnam =</span> <span class="st">"Southeast Asia"</span></a>
<a class="sourceLine" id="cb11-13" title="13">)</a>
<a class="sourceLine" id="cb11-14" title="14">Refugees<span class="op">$</span>region &lt;-<span class="st"> </span>country_regions[Refugees<span class="op">$</span>country]</a>
<a class="sourceLine" id="cb11-15" title="15"><span class="kw">ggplot</span>(<span class="dt">data =</span> Refugees,</a>
<a class="sourceLine" id="cb11-16" title="16">       <span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> refugees, <span class="dt">alluvium =</span> country)) <span class="op">+</span></a>
<a class="sourceLine" id="cb11-17" title="17"><span class="st">  </span><span class="kw"><a href="../reference/geom_alluvium.html">geom_alluvium</a></span>(<span class="kw">aes</span>(<span class="dt">fill =</span> country, <span class="dt">colour =</span> country),</a>
<a class="sourceLine" id="cb11-18" title="18">                <span class="dt">alpha =</span> <span class="fl">.75</span>, <span class="dt">decreasing =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb11-19" title="19"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">2003</span>, <span class="dv">2013</span>, <span class="dv">2</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb11-20" title="20"><span class="st">  </span><span class="kw">theme_bw</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb11-21" title="21"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">-30</span>, <span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb11-22" title="22"><span class="st">  </span><span class="kw">scale_fill_brewer</span>(<span class="dt">type =</span> <span class="st">"qual"</span>, <span class="dt">palette =</span> <span class="st">"Set3"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb11-23" title="23"><span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="dt">type =</span> <span class="st">"qual"</span>, <span class="dt">palette =</span> <span class="st">"Set3"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb11-24" title="24"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>region, <span class="dt">scales =</span> <span class="st">"fixed"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb11-25" title="25"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">"refugee volume by country and region of origin"</span>)</a></code></pre></div>
<pre><code>## Warning in f(...): Some differentiation aesthetics vary within alluvia, and will be diffused by their first value.
## Consider using `geom_flow()` instead.</code></pre>
<p><img src="ggalluvial_files/figure-html/time%20series%20alluvia%20diagram%20of%20refugees%20dataset-1.png" width="576" style="display: block; margin: auto;"></p>
<p>The format allows us to assign aesthetics that change from axis to axis along the same alluvium, which is useful for repeated measures datasets. This requires generating a separate graphical object for each flow, as implemented in <code><a href="../reference/geom_flow.html">geom_flow()</a></code>. The plot below uses a set of (changes to) students’ academic curricula over the course of several semesters. Since <code><a href="../reference/geom_flow.html">geom_flow()</a></code> calls <code><a href="../reference/stat_flow.html">stat_flow()</a></code> by default (see the next example), we override it with <code><a href="../reference/stat_alluvium.html">stat_alluvium()</a></code> in order to track each student across all semesters:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(majors)</a>
<a class="sourceLine" id="cb13-2" title="2">majors<span class="op">$</span>curriculum &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(majors<span class="op">$</span>curriculum)</a>
<a class="sourceLine" id="cb13-3" title="3"><span class="kw">ggplot</span>(majors,</a>
<a class="sourceLine" id="cb13-4" title="4">       <span class="kw">aes</span>(<span class="dt">x =</span> semester, <span class="dt">stratum =</span> curriculum, <span class="dt">alluvium =</span> student,</a>
<a class="sourceLine" id="cb13-5" title="5">           <span class="dt">fill =</span> curriculum, <span class="dt">label =</span> curriculum)) <span class="op">+</span></a>
<a class="sourceLine" id="cb13-6" title="6"><span class="st">  </span><span class="kw">scale_fill_brewer</span>(<span class="dt">type =</span> <span class="st">"qual"</span>, <span class="dt">palette =</span> <span class="st">"Set2"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb13-7" title="7"><span class="st">  </span><span class="kw"><a href="../reference/geom_flow.html">geom_flow</a></span>(<span class="dt">stat =</span> <span class="st">"alluvium"</span>, <span class="dt">lode.guidance =</span> <span class="st">"frontback"</span>,</a>
<a class="sourceLine" id="cb13-8" title="8">            <span class="dt">color =</span> <span class="st">"darkgray"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb13-9" title="9"><span class="st">  </span><span class="kw"><a href="../reference/geom_stratum.html">geom_stratum</a></span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb13-10" title="10"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb13-11" title="11"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">"student curricula across several semesters"</span>)</a></code></pre></div>
<p><img src="ggalluvial_files/figure-html/alluvial%20diagram%20of%20majors%20dataset-1.png" width="576" style="display: block; margin: auto;"></p>
<p>The stratum heights <code>y</code> are unspecified, so each row is given unit height. This example demonstrates one way <strong>ggalluvial</strong> handles missing data. The alternative is to set the parameter <code>na.rm</code> to <code>TRUE</code>.<a href="#fn7" class="footnote-ref" id="fnref7"><sup>7</sup></a> Missing data handling (specifically, the order of the strata) also depends on whether the <code>stratum</code> variable is character or factor/numeric.</p>
<p>Finally, lode format gives us the option to aggregate the flows between adjacent axes, which may be appropriate when the transitions between adjacent axes are of primary importance. We can demonstrate this option on data from the influenza vaccination surveys conducted by the <a href="https://alpdata.rand.org/">RAND American Life Panel</a>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(vaccinations)</a>
<a class="sourceLine" id="cb14-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/levels">levels</a></span>(vaccinations<span class="op">$</span>response) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rev">rev</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/levels">levels</a></span>(vaccinations<span class="op">$</span>response))</a>
<a class="sourceLine" id="cb14-3" title="3"><span class="kw">ggplot</span>(vaccinations,</a>
<a class="sourceLine" id="cb14-4" title="4">       <span class="kw">aes</span>(<span class="dt">x =</span> survey, <span class="dt">stratum =</span> response, <span class="dt">alluvium =</span> subject,</a>
<a class="sourceLine" id="cb14-5" title="5">           <span class="dt">y =</span> freq,</a>
<a class="sourceLine" id="cb14-6" title="6">           <span class="dt">fill =</span> response, <span class="dt">label =</span> response)) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-7" title="7"><span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="dt">expand =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(.<span class="dv">1</span>, <span class="fl">.1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-8" title="8"><span class="st">  </span><span class="kw"><a href="../reference/geom_flow.html">geom_flow</a></span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb14-9" title="9"><span class="st">  </span><span class="kw"><a href="../reference/geom_stratum.html">geom_stratum</a></span>(<span class="dt">alpha =</span> <span class="fl">.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-10" title="10"><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">stat =</span> <span class="st">"stratum"</span>, <span class="dt">size =</span> <span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-11" title="11"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"none"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-12" title="12"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">"vaccination survey responses at three points in time"</span>)</a></code></pre></div>
<p><img src="ggalluvial_files/figure-html/alluvial%20diagram%20of%20vaccinations%20dataset-1.png" width="576" style="display: block; margin: auto;"></p>
<p>This diagram ignores any continuity between the flows between axes. This “memoryless” plot produces a less cluttered diagram, in which at most one flow proceeds from each stratum at one axis to each stratum at the next, but at the cost of being able to track each cohort across the entire diagram.</p>
</div>
</div>
<div id="appendix" class="section level2">
<h2 class="hasAnchor">
<a href="#appendix" class="anchor"></a>Appendix</h2>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">sessioninfo<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/sessioninfo/topics/session_info">session_info</a></span>()</a></code></pre></div>
<pre><code>## ─ Session info ──────────────────────────────────────────────────────────
##  setting  value                       
##  version  R version 3.3.3 (2017-03-06)
##  os       macOS  10.13.6              
##  system   x86_64, darwin13.4.0        
##  ui       X11                         
##  language (EN)                        
##  collate  en_US.UTF-8                 
##  ctype    en_US.UTF-8                 
##  tz       &lt;NA&gt;                        
##  date     2019-09-02                  
## 
## ─ Packages ──────────────────────────────────────────────────────────────
##  package      * version     date       lib
##  assertthat     0.2.1       2019-03-21 [1]
##  backports      1.1.4       2019-04-10 [1]
##  cli            1.1.0       2019-03-19 [1]
##  colorspace     1.4-1       2019-03-18 [1]
##  commonmark     1.7         2018-12-01 [1]
##  crayon         1.3.4       2017-09-16 [1]
##  desc           1.2.0       2018-05-01 [1]
##  digest         0.6.20      2019-07-04 [1]
##  dplyr          0.8.3       2019-07-04 [1]
##  ellipsis       0.2.0.1     2019-07-02 [1]
##  evaluate       0.13        2019-02-12 [1]
##  fs             1.2.7       2019-03-19 [1]
##  ggalluvial   * 0.9.2.0001  2019-09-02 [1]
##  ggplot2      * 3.2.1       2019-08-10 [1]
##  glue           1.3.1       2019-03-12 [1]
##  gtable         0.3.0       2019-03-25 [1]
##  htmltools      0.3.6       2017-04-28 [1]
##  knitr          1.22        2019-03-08 [1]
##  labeling       0.3         2014-08-23 [1]
##  lazyeval       0.2.2       2019-03-15 [1]
##  lifecycle      0.1.0       2019-08-01 [1]
##  magrittr       1.5         2014-11-22 [1]
##  MASS           7.3-45      2016-04-21 [1]
##  memoise        1.1.0       2017-04-21 [1]
##  munsell        0.5.0       2018-06-12 [1]
##  pillar         1.4.2       2019-06-29 [1]
##  pkgconfig      2.0.2       2018-08-16 [1]
##  pkgdown        1.3.0       2018-12-07 [1]
##  plyr           1.8.4       2016-06-08 [1]
##  purrr          0.3.2       2019-03-15 [1]
##  R6             2.4.0       2019-02-14 [1]
##  RColorBrewer   1.1-2       2014-12-07 [1]
##  Rcpp           1.0.2       2019-07-25 [1]
##  rlang          0.4.0       2019-06-25 [1]
##  rmarkdown      1.12        2019-03-14 [1]
##  roxygen2       6.1.1       2018-11-07 [1]
##  rprojroot      1.3-2       2018-01-03 [1]
##  scales         1.0.0       2018-08-09 [1]
##  sessioninfo    1.1.1       2018-11-05 [1]
##  stringi        1.4.3       2019-03-12 [1]
##  stringr        1.4.0       2019-02-10 [1]
##  tibble         2.1.3       2019-06-06 [1]
##  tidyr          0.8.99.9000 2019-08-31 [1]
##  tidyselect     0.2.5       2018-10-11 [1]
##  vctrs          0.2.0       2019-07-05 [1]
##  withr          2.1.2       2018-06-23 [1]
##  xfun           0.5         2019-02-20 [1]
##  xml2           1.2.0       2018-01-24 [1]
##  yaml           2.2.0       2018-07-25 [1]
##  zeallot        0.1.0       2018-01-28 [1]
##  source                                 
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.3)                         
##  CRAN (R 3.3.3)                         
##  CRAN (R 3.3.3)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  Github (corybrunson/ggalluvial@e087455)
##  CRAN (R 3.3.3)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.0)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.3)                         
##  CRAN (R 3.3.0)                         
##  CRAN (R 3.3.3)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.3)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.0)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.0)                         
##  CRAN (R 3.3.3)                         
##  CRAN (R 3.3.3)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.3)                         
##  Github (tidyverse/tidyr@8b89cef)       
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.3)                         
##  Github (jimhester/withr@dbcd7cd)       
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
##  CRAN (R 3.3.2)                         
## 
## [1] /Library/Frameworks/R.framework/Versions/3.3/Resources/library</code></pre>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>See Friendly’s tutorial, linked above, for a discussion.<a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>Previously, weights were passed to the <code>weight</code> aesthetic rather than to <code>y</code>. This prevented <code>scale_y_continuous()</code> from correctly transforming scales, and anyway it was inconsistent with the behavior of <code>geom_bar()</code>.<a href="#fnref2" class="footnote-back">↩</a></p></li>
<li id="fn3"><p><a href="https://github.com/thomasp85/ggforce">The <strong>ggforce</strong> package</a> includes parallel set geom and stat layers to produce similar diagrams that can be allowed to free-float.<a href="#fnref3" class="footnote-back">↩</a></p></li>
<li id="fn4"><p>A greater variety of parallel sets plots are implemented in <a href="https://github.com/heike/ggparallel">the <strong>ggparallel</strong> package</a>.<a href="#fnref4" class="footnote-back">↩</a></p></li>
<li id="fn5"><p>If bumping is unnecessary, consider using <a href="http://www.r-graph-gallery.com/136-stacked-area-chart/"><code>geom_area()</code></a> instead.<a href="#fnref5" class="footnote-back">↩</a></p></li>
<li id="fn6"><p><code><a href="../reference/stat_stratum.html">stat_stratum()</a></code> will similarly accept arguments for <code>x</code> and <code>stratum</code> without <code>alluvium</code>. If both strata and either alluvia or flows are to be plotted, though, all three parameters need arguments.<a href="#fnref6" class="footnote-back">↩</a></p></li>
<li id="fn7"><p>Be sure to set <code>na.rm</code> consistently in each layer, in this case both the flows and the strata.<a href="#fnref7" class="footnote-back">↩</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#alluvial-diagrams">Alluvial diagrams</a></li>
      <li><a href="#alluvial-data">Alluvial data</a></li>
      <li><a href="#appendix">Appendix</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Jason Cory Brunson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
